ARG BASE_IMAGE
ARG BASE_TAG
FROM ${BASE_IMAGE}:${BASE_TAG} as base

ARG CONTAINER_NAME
ARG COMMAND
ENV CONTAINER_NAME=${CONTAINER_NAME}
ENV COMMAND=${COMMAND}

FROM base as test
ARG DB_HOST
ARG DB_PORT
ARG DB_USERNAME
ARG DB_PASSWORD
ARG MUD_PEPPER
ENV DB_HOST=${DB_HOST}
ENV DB_PORT=${DB_PORT}
ENV DB_USERNAME=${DB_USERNAME}
ENV DB_PASSWORD=${DB_PASSWORD}
ENV MUD_PEPPER=${MUD_PEPPER}
CMD sh -c "go test ./..."

FROM base as prod
WORKDIR /app
COPY . .
RUN go install
VOLUME /mnt/logs

CMD sh -c "${COMMAND} 2>&1 | tee -a /mnt/logs/${CONTAINER_NAME}.log"
